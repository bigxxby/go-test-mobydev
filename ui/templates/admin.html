<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        #window {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 9999;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>

    <h1>User List</h1>
    <table id="userTable">
        <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Password</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Date of Birth</th>
            <th>Session ID</th>
            <th>Is Admin</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Deleted At</th>
            <th>Edit</th>
        </tr>
    </table>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            getUsers(); // Загрузить пользователей при загрузке страницы

            // Добавляем слушатель событий для кнопки закрытия окна
            const closeButton = document.getElementById('closeButton');
            closeButton.addEventListener('click', function () {
                const windowDiv = document.getElementById('window');
                windowDiv.style.display = 'none';
            });
            // Добавляем слушатель событий для кнопки удаления
            const deleteButton = document.getElementById('deleteButton');
            deleteButton.addEventListener('click', function () {
                const userId = document.getElementById('userId').textContent;

                if (confirm("Are you sure you want to delete this user?")) {
                    fetch(`/deleteUser?userId=${userId}`, { // Замените на эту строку
                        method: 'DELETE'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            alert('User deleted successfully:', data);
                            // You can add further actions here if needed, like closing the window or refreshing the user list
                        })
                        .catch(error => {
                            alert('There was a problem with your fetch operation:', error);
                            console.log(error);
                        });
                }

            });


            // Добавляем слушатель событий для кнопки отправки
            const sendButton = document.getElementById('sendButton');
            sendButton.addEventListener('click', function () {
                const userId = document.getElementById('userId').textContent;
                const inputs = document.querySelectorAll('#window input[data-attribute]');
                const updatedUserData = {
                    user_id: userId
                };

                inputs.forEach(input => {
                    const attribute = input.getAttribute('data-attribute');
                    if (input.type === 'checkbox') {
                        updatedUserData[attribute] = input.checked;
                    } else {
                        updatedUserData[attribute] = input.value;
                    }
                });

                fetch('/updateUserAdmin', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedUserData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        alert("User updated")
                        return response.json();
                    })
            });
        });

        function getUsers() {
            fetch('/getAllUsers')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const userTable = document.getElementById('userTable');
                    data.forEach(user => {
                        const row = userTable.insertRow();
                        row.innerHTML = `
                        <td id="user${user.id}">${user.id}</td>
                        <td>${user.email}</td>
                        <td>${user.password}</td>
                        <td>${user.name}</td>
                        <td>${user.phone}</td>
                        <td>${user.date_of_birth}</td>
                        <td>${user.session_id}</td>
                        <td>${user.is_admin}</td>
                        <td>${user.created_at}</td>
                        <td>${user.updated_at}</td>
                        <td>${user.deleted_at}</td>
                        <td><button class="editButton">Edit</button></td>
                    `;
                    });

                    // Добавляем слушатель событий для каждой кнопки редактирования
                    const editButtons = document.querySelectorAll('.editButton');
                    editButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            const userId = this.parentElement.parentElement.querySelector('td:first-child').innerText;
                            const windowDiv = document.getElementById('window');
                            const userIdField = windowDiv.querySelector('#userId');
                            userIdField.textContent = userId;

                            // Заполняем поля ввода данными пользователя
                            const user = data.find(u => u.id === parseInt(userId));
                            const inputs = windowDiv.querySelectorAll('input[data-attribute], textarea[data-attribute]');
                            inputs.forEach(input => {
                                const attribute = input.getAttribute('data-attribute');
                                if (input.type === 'checkbox') {
                                    input.checked = user[attribute];
                                } else {
                                    input.value = user[attribute];
                                }
                            });

                            windowDiv.style.display = 'block';
                        });
                    });
                })
                .catch(error => {
                    console.error('There was a problem with your fetch operation:', error);
                });
        }
    </script>
    <div class="window" id="window">
        <!-- Edit window content -->
        <h2>Edit Window</h2>
        <p>User ID: <span id="userId"></span></p>
        <label>Email: <input type="text" data-attribute="email"></label><br>
        <label>Name: <input type="text" data-attribute="name"></label><br>
        <label>Phone: <input type="text" data-attribute="phone"></label><br>
        <label>Date of Birth: <input type="date" data-attribute="date_of_birth"></label><br>
        <label>Is Admin: <input type="checkbox" data-attribute="is_admin"></label><br>
        <button id="sendButton">Send</button>
        <button id="closeButton">Close</button>
        <button id="deleteButton">Delete</button>
    </div>
</body>

</html>